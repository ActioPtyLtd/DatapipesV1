{
  "script": {
    "schema": {},
    "tasks": {
      "dumpthis": {
        "type": "dump"
      },
      "read-schedules": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "sql",
          "behavior": "",
          "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
          "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
          "query": {
            "queryTemplate": "",
            "read": "SELECT top 2000 courseid+':'+room courseid,moduleid,room,year,  CONVERT(varchar, SWITCHOFFSET(CONVERT(datetimeoffset, startdatetime), DATENAME(TzOffset, SYSDATETIMEOFFSET())),126) startdatetime,CONVERT(varchar, SWITCHOFFSET(CONVERT(datetimeoffset, enddatetime), DATENAME(TzOffset, SYSDATETIMEOFFSET())),126) enddatetime,duration*60*1000 duration,presenterusername,presenterfullname FROM [Mediasite].[dbo].[mediasite_activities] where presenterUsername is not null order by moduleid "
          }
        }
      },
      "read_modules": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "sql",
          "behavior": "",
          "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
          "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
          "query": {
            "queryTemplate": "",
            "read": "select distinct moduleid from mediasite_activities where PresenterUsername is not null order by moduleid"
          }
        }
      },
      "load_folder_uuid": {
        "type": "join",
        "behavior": "",
        "iterateR": "ds => ds.value",
        "keyL": "$moduleid",
        "keyR": "$Name",
        "changeL": "$moduleid",
        "changeR": "$Id",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders?$skip=0&$top=100000"
            }
          }
        }
      },
      "load_module_uuid": {
        "type": "join",
        "behavior": "",
        "iterateR": "ds => ds.value",
        "keyL": "$moduleid",
        "keyR": "$ModuleId",
        "changeL": "$moduleid",
        "changeR": "$Id",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules"
            }
          }
        }
      },

      "assign-schedule-template": {
        "type": "mergeTemplate",
        "templates": {
          "assignschedulebody": "{\"RecorderId\":\"10b3cc97af734dd99a22924df580e8b94e\",\"Name\": \"${courseid}\",\"FolderId\": \"${load_folder_uuid.item.Id}\",\"DeleteInactive\":true,\"LoadPresentation\":true,\"AutoStart\":true,\"AutoStop\":true,\"TitleType\":\"ScheduleNameAndAirDateTime\",\"ScheduleTemplateId\" : \"a76e993574d94730b4b251900f0643580b\"}"
        }
      },
      "create_schedule": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules",
              "body": "assignschedulebody"
            }
          }
        }
      },
      "assign_recurrence": {
        "type": "mergeTemplate",
        "templates": {
          "schedulehdr": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules('${create_schedule(0).Id}')/Recurrences",
          "assignschedulebody": "{\"RecordDuration\" : ${row.duration},\"StartRecordDateTime\" : \"${row.startdatetime}\",\"EndRecordDateTime\" : \"${row.enddatetime}\"}"
        }
      },
      "create_recurrence": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "schedulehdr",
              "body": "assignschedulebody"
            }
          }
        }
      },
      "association_template": {
        "type": "mergeTemplate",
        "templates": {
          "association_template_hdr": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules('${record.row.load_module_uuid.item.Id}')/AddAssociation",
          "association_body": "{\"MediasiteId\":\"${record.create_schedule(0).Id}\"}"
        }
      },
      "module_association": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb":"post",
              "uri": "association_template_hdr",
              "body": "association_body"
            }
          }
        }
      },
      "get_schedules": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb" : "get",
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules?$skip=0&$top=2000"
            }
          }
        }
      },
      "merge_del_schedule": {
        "type": "mergeTemplate",
        "templates": {
          "merge_del_hdr": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules('${Id}')"
        }
      },
      "delete_schedules": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb":"delete",
              "uri": "merge_del_hdr",
              "body": ""
            }
          }
        }
      },
      "tr1": {
        "type": "transformTerm",
        "term": "ds => batch( ds.value )"
      },
      "t_catalog": {
        "type": "mergeTemplate",
        "templates": {
          "catabody": "{\"SearchTerm\" : \"$moduleid\",\"Name\" : \"$moduleid\"}"
        }
      },
      "setup_catalog": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb":"post",
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs",
              "body": "catabody"
            }
          }
        }
      },
      "t_catalog_put": {
        "type": "mergeTemplate",
        "templates": {
          "catahdr_put" : "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs/('${setup_catalog(0).Id}')",
          "catabody_put": "{\"SearchTerm\" : \"ModuleAssociations:${row.moduleid}\",\"LimitSearchToCatalog\": false,\"IsMyMediasiteChannel\": false}"
        }
      },
    "set_catalog_search": {
      "type": "lookup",
      "behavior": "simple",
      "dataSource": {
        "type": "rest",
        "behavior": "simple",
        "path": "-",
        "headers": {
          "Content-Type": "application/json",
          "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        "credential": {
          "user": "ACTIO",
          "password": "actio1234"
        },
        "query": {
          "read": {
            "verb": "put",
            "uri": "catahdr_put",
            "body": "catabody_put"
          }
        }
      }
    },
      "module_uuid": {
        "type": "join",
        "behavior": "",
        "iterateR": "ds => ds.value",
        "keyL": "${record.row.moduleid}",
        "keyR": "$ModuleId",
        "changeL": "${record.row.moduleid}",
        "changeR": "$Id",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules"
            }
          }
        }
      },
      "t_catalog_module": {
        "type": "mergeTemplate",
        "templates": {
          "catamodhdr": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules('${module_uuid.item.Id}')/AddAssociation'",
          "catamodbody": "{\"MediasiteId\" : \"${record.setup_catalog(0).Id}\" }"
        }
      },
      "assign_catalog_module": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "catamodhdr",
              "body": "catamodbody"
            }
          }
        }
      }
    },
    "pipelines": {
      "create-schedules" : {
          "pipe" : "read-schedules | load_module_uuid | load_folder_uuid | assign-schedule-template | create_schedule | assign_recurrence | create_recurrence | association_template | module_association "
      },
      "create_catalogs" : {
        "pipe" : "read_modules | t_catalog | setup_catalog | dumpthis | t_catalog_put | set_catalog_search | module_uuid | t_catalog_module | assign_catalog_module"
      },
      "delete_all_schedules" :
      {
        "pipe" : " get_schedules | tr1 | dumpthis | merge_del_schedule | delete_schedules "
      }
    },
    "services": { },
    "startup": {
      "exec": "create_catalogs"
    }
  }
}
