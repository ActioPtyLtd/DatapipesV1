{
  "script": {
    "schema": {},
    "tasks": {
      "read-order-csv": {
        "type": "extract",
        "behavior": "simple",
        "dataSource": {
          "behavior": "regex",
          "directory": "C:\\Users\\mauri\\bitbucket\\gandm-data",
          "type": "file",
          "filenameTemplate": "gmSpecOrder_sample.csv"
        }
      },
      "parse-order-csv": {
        "type": "transform",
        "batch": [
          "split2cols,col1",
          "row1header"
          ]
      },
      "update-order-api": {
        "type": "load",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "https://dev-api-gnm.actio.com.au:8443/service/order",
          "credential": {
            "user": "admin",
            "password": "password"
          },
          "query": {
            "create": {
              "uri": "https://dev-api-gnm.actio.com.au:8443/service/order",
              "body": "{\"customer\": {\"customer_id\": \"@{d.0.patientreference}\",\"first_name\": \"@{d.0.patientgivenname}\",\"last_name\": \"@{d.0.patientsurname}\",\"telephone\": \"1234\"},\"delivery_address\": {\"attention\": \"Peter Hewett\",\"number\": \"799\",\"postcode\": \"2088\",\"state\": \"NSW\",\"street1\": \"Military Road\",\"street2\": \"-\",\"street3\": \"Australia\",\"suburb\": \"Mosman\"},\"invoice_id\": \"0001\", @{products},\"store_id\": \"PHHEW\",\"submitted_date_time\": \"@{(convertDateFormat,d.0.orderdate,'d/MM/yyyy','yyyy-MM-dd')}T00:00:00.000Z\"}",
              "templates": {
                "products": "\"order_items\": [@{(concatString,[(if,(isBlank,d.0.spectaclemeasurement_framesuppliercode),(nothing),frame),(if,(isBlank,d.0.leftlens_supplierlenscode),(nothing),leftlens),(if,(isBlank,d.0.rightlens_supplierlenscode),(nothing),rightlens)])}]",
                "frame": "{\"product_id\": \"@{d.0.spectaclemeasurement_framesuppliercode}\",\"quantity\": 1}",
                "leftlens": "{\"attributes\": [{\"name\": \"left_lens_size\",\"type\": \"decimal\",\"value\": \"@{d.0.leftlens_lenssize}\"},{\"name\": \"left_lens_sphere\",\"type\": \"string\",\"value\": \"@{d.0.leftlens_sphere}\"},{\"name\": \"left_lens_cylindar\",\"type\": \"string\",\"value\": \"@{d.0.leftlens_cylinder}\"},{\"name\": \"left_lens_axis\",\"type\": \"string\",\"value\": \"@{d.0.leftlens_axis}\"},{\"name\": \"left_lens_seg_size\",\"type\": \"decimal\",\"value\": \"@{d.0.leftlens_segsize}\"},{\"name\": \"left_lens_box_height\",\"type\": \"decimal\",\"value\": \"@{d.0.leftlens_boxheight}\"},{\"name\": \"left_lens_box_width\",\"type\": \"decimal\",\"value\": \"@{d.0.leftlens_boxwidth}\"}], \"product_id\": \"@{d.0.leftlens_supplierlenscode}\",\"quantity\": 1}",
                "rightlens": "{\"attributes\": [{\"name\": \"right_lens_size\",\"type\": \"decimal\",\"value\": \"@{d.0.rightlens_lenssize}\"},{\"name\": \"right_lens_sphere\",\"type\": \"string\",\"value\": \"@{d.0.rightlens_sphere}\"},{\"name\": \"right_lens_cylindar\",\"type\": \"string\",\"value\": \"@{d.0.rightlens_cylinder}\"},{\"name\": \"right_lens_axis\",\"type\": \"string\",\"value\": \"@{d.0.rightlens_axis}\"},{\"name\": \"right_lens_seg_size\",\"type\": \"decimal\",\"value\": \"@{d.0.rightlens_segsize}\"},{\"name\": \"right_lens_box_height\",\"type\": \"decimal\",\"value\": \"@{d.0.rightlens_boxheight}\"},{\"name\": \"right_lens_box_width\",\"type\": \"decimal\",\"value\": \"@{d.0.rightlens_boxwidth}\"}], \"product_id\": \"@{d.0.rightlens_supplierlenscode}\",\"quantity\": 1}"
              }
            }
          }
        }
      }
    },
    "pipelines": {
      "load-order" : {
        "pipe": "read-order-csv | parse-order-csv | update-order-api"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-order"
    }
  }
}
