{
  "script": {
    "schema": {},
    "tasks": {
      "read-invoice-csv": {
        "type": "extract",
        "behavior": "simple",
        "dataSource": {
          "behavior": "regex",
          "directory": "C:\\Users\\mauri\\bitbucket\\gandm-data\\Sunix\\Hanks-PMQ\\2016-06-02",
          "type": "file",
          "filenameTemplate": "VACCOUNT.CSV"
        }
      },
      "parse-invoice-csv": {
        "type": "transform",
        "batch": [
          "split2cols,col1",
          "row1header",
          "const,HAPMQ,0",
          "trim,refnum",
          "concat,const1,accnum,-",
          "concat,const1,refnum1,-",
          "concat,const1,optom,-",
          "sum,sungamt,confee,clensamt,specamt,frameamt,miscamt",
          "convdate,accdate,MM/dd/yyyy,yyyy-MM-dd",
          "rename,concat1,externalref,accdate1,createddate,sum1,totalcost,const2,orderid"]
      },
      "lookup-store": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "lookup1": "const1",
        "lookup2": "code",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/test?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "select id,code from store"
          }
        }
      },
      "lookup-customer": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "lookup1": "concat2",
        "lookup2": "externalref",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/test?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "select id,externalref from customer where externalref in ($1)"
          }
        }
      },
      "lookup-employee": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "lookup1": "concat3",
        "lookup2": "externalref",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/test?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "select id,externalref from employee where externalref in ($1)"
          }
        }
      },
      "prep-invoice": {
        "type": "transform",
        "batch": [
          "defaultIfBlank,id1,id2,id3,0",
          "rename,id4,storeid,id5,customerid,id6,employeeid",
          "keep,externalref,orderid,createddate,storeid,customerid,employeeid,totalcost"
        ]
      },
      "update-invoice-db": {
        "type": "datasourceupdate",
        "behavior": "",
        "keys": [
          "externalref"
        ],
        "dataSource": {
          "type": "sql",
          "behavior": "",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/test?user=postgres&password=postgres",
          "query": {
            "create": "insert into invoice (externalref,orderid,createddate,storeid,customerid,employeeid,totalcost) values (@externalref,@orderid::int,@createddate::timestamp,@storeid::int,@customerid::int,@employeeid::int,@totalcost::money)",
            "read": "select externalref,orderid,createddate::date as createddate,storeid,customerid,employeeid,totalcost::numeric as totalcost from invoice",
            "update": "update invoice set orderid=@orderid::int,createddate=@createddate::timestamp,storeid=@storeid::int,customerid=@customerid::int,employeeid=@employeeid::int,totalcost=@totalcost::money where externalref = @externalref",
            "queryTemplate": ""
          }
        }
      }
    },
    "pipelines": {
      "load-invoice" : {
        "pipe": "read-invoice-csv | parse-invoice-csv | lookup-store | lookup-customer | lookup-employee | prep-invoice | update-invoice-db"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-invoice"
    }
  }
}
