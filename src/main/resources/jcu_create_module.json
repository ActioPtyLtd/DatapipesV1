{
  "script": {
    "schema": {},
    "tasks": {
        "read-modules": {
          "type": "extract",
          "behavior": "",
          "dataSource": {
            "type": "sql",
            "behavior": "",
            "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
            "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
            "query": {
              "queryTemplate": "",
              "read": "select distinct moduleid from mediasite_activities where PresenterUsername is not null"
            }
          }
        },
        "read_module_owner": {
          "type": "extract",
          "behavior": "",
          "dataSource": {
            "type": "sql",
            "behavior": "",
            "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
            "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
            "query": {
              "queryTemplate": "",
              "read": "select distinct moduleid,presenterusername from mediasite_activities where PresenterUsername is not null order by moduleid"
            }
          }
        },
        "template-module": {
          "type": "mergeTemplate",
          "templates": {
            "modulecreatebody": "{ \"ModuleId\": \"xx$moduleid\", \"Name\": \"$moduleid\", \"Description\": \"$moduleid\", \"Owner\": \"MediasiteAdmin\"}"
          }
        },
        "tr1": {
          "type": "transformTerm",
          "term": "ds => ds"
        },
        "create-module-merge": {
          "type": "merge",
          "behavior": "simple",
          "attribute": "module",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "create": {
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules",
                "body": "modulecreatebody"
              }
            }
          }
        },
        "batch1": {
          "type": "transformTerm",
          "term": "ds => batch(batch(ds))"
        },
        "template-createfolder": {
          "type": "mergeTemplate",
          "templates": {
            "foldercreatebody": "{ \"Name\": \"${module.root.ModuleId}\", \"Owner\": \"MediasiteAdmin\", \"ParentFolderId\": \"7c06968cc79c44eea80b89c627d2ac4b14\", \"Recycled\": false, \"Type\": \"Folder\", \"IsShared\": false, \"IsCopyDestination\": true, \"IsReviewEditApproveEnabled\": true}"
          }
        },
        "create-folder-merge": {
          "type": "merge",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "create": {
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders",
                "body": "foldercreatebody"
              }
            }
          }
        },
        "owner-folder": {
          "type": "mergeTemplate",
          "templates": {
            "owneruri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders('${folder.root.Id}')/UpdateOwner",
            "ownercreatebody": "{ \"Owner\": \"$presenterusername\" }"
          }
        },
        "owner-folder-merge": {
          "type": "merge",
          "behavior": "simple",
          "attribute": "ownerfolder",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "create": {
                "uri": "owneruri",
                "body": "ownercreatebody"
              }
            }
          }
        },
        "schedule-template": {
          "type": "mergeTemplate",
          "templates": {
            "schedulebody": "{\"ScheduleTemplateId\":\"0eddda4fd7304a0ca530acf593b76d3f0b\",  \"RecorderId\":\"eefd2ec11f5749fd9ab777f2c1f358d816\",  \"Name\": \"Schedule_APIcreated\",  \"TitleType\": \"ScheduleNameAndAirDateTime\",  \"FolderId\": \"${folder.root.Id}\",  \"AdvanceCreationTime\": \"172800\",  \"AdvanceLoadTimeInSeconds\": \"120\",  \"CreatePresentation\": \"true\",  \"LoadPresentation\": \"true\",  \"AutoStart\": \"true\",  \"AutoStop\": \"true\",  \"ReceipientsEmailAddresses\": \"jmckinney@webcastcloud.com.au\",  \"NextNumberInSchedule\": \"2\",  \"Description\": \"Presentation Created via API w/ Presenter email sent Hopefully\",  \"ReviewEditApproveEnabled\": \"true\"}"
          }
        },
        "create-schedule": {
          "type": "merge",
          "behavior": "simple",
          "attribute": "schedule",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
            },
            "credential": {
              "user": "ACTIO",
              "password": "ACTIO1234!"
            },
            "query": {
              "create": {
                "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Schedules",
                "body": "schedulebody"
              }
            }
          }
        },
        "assign-schedule-template": {
          "type": "mergeTemplate",
          "templates": {
            "assignscheduleuri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Modules('${module.root.Id}')/AddAssociation",
            "assignschedulebody": "{\"MediasiteId\":\"${schedule.root.Id}\"}"
          }
        },
        "assign-schedule": {
          "type": "merge",
          "behavior": "simple",
          "attribute": "schedulemodule",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
            },
            "credential": {
              "user": "ACTIO",
              "password": "ACTIO1234!"
            },
            "query": {
              "create": {
                "uri": "assignscheduleuri",
                "body": "assignschedulebody"
              }
            }
          }
        },
        "getdata": {
          "type": "transformTerm",
          "term": "ds => batch(ds.data)"
        },
        "dumpthis": {
          "type": "dump"
        },

        "module-templates": {
          "type": "mergeTemplate",
          "templates": {
            "createmodule": "{ \"ModuleId\": \"$moduleid\", \"Name\": \"$moduleid\", \"Description\": \"$moduleid\", \"Owner\": \"MediasiteAdmin\"}",
            "createfolder": "{ \"Name\": \"$moduleid\", \"Owner\": \"MediasiteAdmin\", \"ParentFolderId\": \"7c06968cc79c44eea80b89c627d2ac4b14\", \"Recycled\": false, \"Type\": \"Folder\", \"IsShared\": false, \"IsCopyDestination\": true, \"IsReviewEditApproveEnabled\": true}"
          }
        },

        "create-module": {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "verb": "post",
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules",
                "body": "createmodule"
              }
            }
          }
        },
        "create-folder": {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "verb": "post",
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders",
                "body": "createfolder"
              }
            }
          }
        },
        "load_folder_uuid": {
          "type": "join",
          "behavior": "",
          "iterateR": "ds => ds.value",
          "keyL": "$moduleid",
          "keyR": "$Name",
          "changeL": "$moduleid",
          "changeR": "$Id",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders?$skip=0&$top=100000"
              }
            }
          }
        },
        "t_owner_folder": {
          "type": "mergeTemplate",
          "templates": {
            "folderhdr" : "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders('${load_folder_uuid.item.Id}')/UpdatePermissions",
            "folderbody": "{ \"Owner\": \"$presenterusername\" }"
          }
        },
        "update_folder_owner" : {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "folderhdr",
              "body": "folderbody"
            }
          }
        }
      }
    },
    "pipelines": {
      "create-module" : {
        "pipe" : "read-modules | dumpthis  | module-templates | dumpthis | create-module "
      },
      "create-folder" : {
        "pipe" : "read-modules | dumpthis  | module-templates | create-folder  "
      },
      "folder_owner" : {
          "pipe" : "read_module_owner | load_folder_uuid | t_owner_folder | update_folder_owner "
      }
    },
    "services": { },
    "startup": {
      "exec": "create-module"
    }
  }
}
