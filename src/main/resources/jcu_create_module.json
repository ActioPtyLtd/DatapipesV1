{
  "script": {
    "schema": {},
    "tasks": {
        "read-modules": {
          "type": "extract",
          "behavior": "",
          "dataSource": {
            "type": "sql",
            "behavior": "",
            "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
            "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
            "query": {
              "queryTemplate": "",
              "read": "select distinct moduleid from current_activities where PresenterUsername is not null and room in ('A003-002','B001-031')"
            }
          }
        },
        "read_module_owner": {
          "type": "extract",
          "behavior": "",
          "dataSource": {
            "type": "sql",
            "behavior": "",
            "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
            "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
            "query": {
              "queryTemplate": "",
              "read": "select distinct moduleid,presenterusername from current_activities where PresenterUsername is not null and room in ('A003-002','B001-031') order  by moduleid"
            }
          }
        },
         "dumpthis": {
          "type": "dump"
        },
        "module-templates": {
          "type": "mergeTemplate",
          "templates": {
            "createmodule": "{ \"ModuleId\": \"$moduleid\", \"Name\": \"$moduleid\", \"Description\": \"$moduleid\", \"Owner\": \"MediasiteAdmin\"}",
            "createfolder": "{ \"Name\": \"$moduleid\", \"Owner\": \"MediasiteAdmin\", \"ParentFolderId\": \"a32209e4986a4953b30649eb090d481414\", \"Recycled\": false, \"Type\": \"Folder\", \"IsShared\": false, \"IsCopyDestination\": true, \"IsReviewEditApproveEnabled\": true}"
          }
        },
        "create-module": {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "verb": "post",
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules",
                "body": "createmodule"
              }
            }
          }
        },
        "create-folder": {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "verb": "post",
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders",
                "body": "createfolder"
              }
            }
          }
        },
        "load_folder_uuid": {
          "type": "join",
          "behavior": "",
          "iterateR": "ds => ds.value",
          "keyL": "a32209e4986a4953b30649eb090d481414$moduleid",
          "keyR": "$ParentFolderId$Name",
          "changeL": "$moduleid",
          "changeR": "$Id",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
            },
            "credential": {
              "user": "ACTIO",
              "password": "actio1234"
            },
            "query": {
              "read": {
                "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders?$skip=0&$top=100000"
              }
            }
          }
        },
        "t_owner_folder": {
          "type": "mergeTemplate",
          "templates": {
            "folderhdr" : "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders('${load_folder_uuid.item.Id}')/UpdateOwner",
            "folderbody": "{ \"Owner\": \"$presenterusername\" }"
          }
        },
        "update_folder_owner" : {
          "type": "lookup",
          "behavior": "simple",
          "dataSource": {
            "type": "rest",
            "behavior": "simple",
            "path": "-",
            "headers": {
              "Content-Type": "application/json",
              "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "folderhdr",
              "body": "folderbody"
            }
          }
        }
      }
    },
    "pipelines": {
      "create-module" : {
        "pipe" : "read-modules | dumpthis  | module-templates | dumpthis | create-module "
      },
      "create-folder" : {
        "pipe" : "read-modules | dumpthis  | module-templates | create-folder | dumpthis  "
      },
      "folder_owner" : {
          "pipe" : "read_module_owner | load_folder_uuid | dumpthis | t_owner_folder | update_folder_owner  "
      }
    },
    "services": { },
    "startup": {
      "exec": "create-module"
    }
  }
}
