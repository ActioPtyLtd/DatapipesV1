{
  "script": {
    "schema": {},
    "tasks": {
      "read-invoice-dbf": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "file",
          "behavior": "DBF",
          "directory": "C:\\Users\\mauri\\bitbucket\\gandm-data\\Sunix\\Hewett Sunix Vision DBF",
          "filenameTemplate": "VACCOUNT.DBF"
        }
      },
      "templatelookup": {
        "type": "mergeTemplate",
        "templates": {
          "lookupemployee": "select sk from employee where employeeid='2088-PH-012-$OPTOM'",
          "lookupcustomer": "select sk from customer where customerid='2088-PH-012-$REFNUM'",
          "lookupstore": "select sk from store where storeid='2088-PH-012'"
        }
      },
      "lookupstorekey": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/gmdwh?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "",
            "read": "lookupstore"
          }
        }
      },
      "lookupemployeekey": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/gmdwh?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "",
            "read": "lookupemployee"
          }
        }
      },
      "lookupcustomerkey": {
        "type": "lookup",
        "behavior": "lookup-merge",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/gmdwh?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "",
            "read": "lookupcustomer"
          }
        }
      },
      "template": {
        "type": "mergeTemplate",
        "templates": {
          "key": "2088-PH-012-${row.ACCNUM}",
          "change": "${convertDateFormat(row.MODIFIED,\"yyyy-MM-dd HH:mm:ss.S\",\"yyyy-MM-dd HH:mm:ss.S\")}",
          "create": "insert into invoice (invoiceid, createddate, storesk, employeesk, customersk, totalcost, modified) values ('2088-PH-012-${row.ACCNUM}', '${row.ACCDATE}'::timestamp, ${numeric(lookupstorekey(0)(0).sk)}, ${numeric(lookupemployeekey(0)(0).sk)}, ${numeric(lookupcustomerkey(0)(0).sk)}, ${sumValues(row.SUNGAMT,row.CONFEE,row.CLENSAMT,row.SPECAMT,row.FRAMEAMT,row.MISCAMT,row.MAMOUNT)}, '${convertDateFormat(row.MODIFIED,\"yyyy-MM-dd HH:mm:ss.S\",\"yyyy-MM-dd HH:mm:ss.S\")}'::timestamp)",
          "update": "update invoice set createddate='${row.ACCDATE}'::timestamp, storesk=${numeric(lookupstorekey(0)(0).sk)}, employeesk=${numeric(lookupemployeekey(0)(0).sk)}, customersk=${numeric(lookupcustomerkey(0)(0).sk)}, totalcost=${sumValues(row.SUNGAMT,row.CONFEE,row.CLENSAMT,row.SPECAMT,row.FRAMEAMT,row.MISCAMT,row.MAMOUNT)} where invoiceid='2088-PH-012-${row.ACCNUM}'"
        }
      },
      "update-invoice-db": {
        "type": "datasourceupdate",
        "behavior": "",
        "iterateR": "ds => ds",
        "keyL": "$key",
        "keyR": "$invoiceid",
        "changeL": "$change",
        "changeR": "$modified",
        "dataSource": {
          "type": "sql",
          "behavior": "",
          "jdbcDriver": "org.postgresql.Driver",
          "connect": "jdbc:postgresql://localhost/gmdwh?user=postgres&password=postgres",
          "query": {
            "queryTemplate": "",
            "create": "create",
            "read": "select invoiceid, modified FROM invoice",
            "update": "update"
          }
        }
      }
    },
    "pipelines": {
      "load-invoice" : {
        "pipe": "read-invoice-dbf | templatelookup | lookupstorekey | lookupemployeekey | lookupcustomerkey | template | update-invoice-db"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-invoice"
    }
  }
}
