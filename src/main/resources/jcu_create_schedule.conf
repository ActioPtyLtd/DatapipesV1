
script {
  schema {},
  tasks {
    dumpthis {
      type = "dump"
    },
    read-schedules {
      type = "extract",
      behavior = "",
      dataSource {
        type = "sql",
        behavior = "",
        jdbcDriver = "com.microsoft.sqlserver.jdbc.SQLServerDriver",
        connect = "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
        query {
          queryTemplate = "",
          read = "SELECT courseid+'_'+room+'_'+presenterfullname courseid,moduleid,room,case when room = 'A003-002' then '69d9184011af4c0e9f6bea8f740bac554e' when room = 'B001-031' then '5f8e944a7a584463a16c2635553f4be24e' end recorderid,year, CONVERT(varchar, SWITCHOFFSET(CONVERT(datetimeoffset, startdatetime), DATENAME(TzOffset, SYSDATETIMEOFFSET())),126) startdatetime,CONVERT(varchar, SWITCHOFFSET(CONVERT(datetimeoffset, enddatetime), DATENAME(TzOffset, SYSDATETIMEOFFSET())),126) enddatetime,duration*60*1000 duration,presenterusername,REPLACE(REPLACE(presenterfullname, CHAR(10), ''), CHAR(13), '') presenterfullname FROM current_activities where presenterUsername is not null AND room in ('A003-002','B001-031') order by moduleid"
        }
      }
    },
    read_modules {
      type = "extract",
      behavior = "",
      dataSource {
        type = "sql",
        behavior = "",
        jdbcDriver = "com.microsoft.sqlserver.jdbc.SQLServerDriver",
        connect = "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
        query {
          queryTemplate = "",
          read = "select distinct moduleid from current_activities where PresenterUsername is not null AND room in ('A003-002','B001-031') order by moduleid"
        }
      }
    },
    load_folder_uuid {
      type = "join",
      behavior = "",
      iterateR = "ds => ds.value",
      keyL = "a32209e4986a4953b30649eb090d481414$moduleid",
      keyR = "$ParentFolderId$Name",
      changeL = "$moduleid",
      changeR = "$Id",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Folders?$skip=0&$top=100000"
          }
        }
      }
    },
    load_module_uuid {
      type = "join",
      behavior = "",
      iterateR = "ds => ds.value",
      keyL = "$moduleid",
      keyR = "$ModuleId",
      changeL = "$moduleid",
      changeR = "$Id",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules"
          }
        }
      }
    },
    t_owner_schedule {
      type = "mergeTemplate",
      templates {
        assignownerhdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/ResourcePermissions('${create_schedule(0).Id}')",
        assignownerbody = "{\"Owner\" : ${row.presenterusername}, \"InheritPermissions\" : true}"
      }
    },
    assign_owner_schedule {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "put",
            uri = "assignownerhdr",
            body = "assignownerbody"
          }
        }
      }
    },
    t_assign_schedule {
      type = "mergeTemplate",
      templates {
        assignschedulebody = "{\"RecorderId\":\"${recorderid}\",\"Name\": \"${courseid}\",\"FolderId\": \"${load_folder_uuid.item.Id}\",\"DeleteInactive\":true,\"LoadPresentation\":true,\"AutoStart\":true,\"AutoStop\":true,\"TitleType\":\"ScheduleNameAndAirDateTime\",\"ScheduleTemplateId\" : \"8e38410214994bfbb194be5312a85c000b\"}"
      }
    },
    create_schedule {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "post",
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules",
            body = "assignschedulebody"
          }
        }
      }
    },
    t_assign_recurrence {
      type = "mergeTemplate",
      templates {
        schedulehdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules('${create_schedule(0).Id}')/Recurrences",
        assignschedulebody = "{\"RecordDuration\" : ${row.duration},\"StartRecordDateTime\" : \"${row.startdatetime}\",\"EndRecordDateTime\" : \"${row.enddatetime}\"}"
      }
    },
    create_recurrence {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "post",
            uri = "schedulehdr",
            body = "assignschedulebody"
          }
        }
      }
    },
    t_module_association {
      type = "mergeTemplate",
      templates {
        association_template_hdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules('${record.row.load_module_uuid.item.Id}')/AddAssociation",
        association_body = "{\"MediasiteId\":\"${record.create_schedule(0).Id}\"}"
      }
    },
    create_module_association {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "post",
            uri = "association_template_hdr",
            body = "association_body"
          }
        }
      }
    },
    get_schedules {
      type = "extract",
      behavior = "",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "get",
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules?$skip=0&$top=2000"
          }
        }
      }
    },
    get_catalogs {
      type = "extract",
      behavior = "",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "get",
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs?$skip=0&$top=5000"
          }
        }
      }
    },
    t_del_catalog {
      type = "mergeTemplate",
      templates {
        merge_del_hdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs('${Id}')"
      }
    },
    process_delete_catalogs {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "delete",
            uri = "merge_del_hdr",
            body = ""
          }
        }
      }
    },
    merge_del_schedule {
      type = "mergeTemplate",
      templates {
        merge_del_hdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Schedules('${Id}')"
      }
    },
    delete_schedules {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "delete",
            uri = "merge_del_hdr",
            body = ""
          }
        }
      }
    },
    tr1 {
      type = "transformTerm",
      term = "ds => batch( ds.value )"
    },
    t_catalog {
      type = "mergeTemplate",
      templates {
        catabody = "{\"Name\" : \"$moduleid\",\"SearchTerm\":\"ModuleAssociations:$moduleid\",\"IsSearchBased\":true,\"LimitSearchToCatalog\":false}"
      }
    },
    setup_catalog {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "post",
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs",
            body = "catabody"
          }
        }
      }
    },
    t_catalog_put {
      type = "mergeTemplate",
      templates {
        catahdr_put = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Catalogs/('${setup_catalog(0).Id}')/Settings",
        catabody_put = "{\"SearchFields\":\"All\",\"SearchTerm\":\"ModuleAssociations:${row.moduleid}\",\"DefaultSortBy\": 1,\"DefaultSortDirection\": 1}"
      }
    },
    set_catalog_search {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "put",
            uri = "catahdr_put",
            body = "catabody_put"
          }
        }
      }
    },
    module_uuid {
      type = "join",
      behavior = "",
      iterateR = "ds => ds.value",
      keyL = "${record.row.moduleid}",
      keyR = "$ModuleId",
      changeL = "${record.row.moduleid}",
      changeR = "$Id",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            uri = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules"
          }
        }
      }
    },
    t_catalog_module {
      type = "mergeTemplate",
      templates {
        catamodhdr = "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/Modules('${module_uuid.item.Id}')/AddAssociation",
        catamodbody = "{\"MediasiteId\" : \"${record.setup_catalog(0).Id}\" }"
      }
    },
    assign_catalog_module {
      type = "lookup",
      behavior = "simple",
      dataSource {
        type = "rest",
        behavior = "simple",
        path = "-",
        headers {
          Content-Type = "application/json",
          sfapikey = "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
        },
        credential {
          user = "ACTIO",
          password = "actio1234"
        },
        query {
          read {
            verb = "post",
            uri = "catamodhdr",
            body = "catamodbody"
          }
        }
      }
    }
  },
  pipelines {
    create-schedules {
      pipe = "read-schedules | load_module_uuid | load_folder_uuid | t_assign_schedule | create_schedule | dumpthis | t_assign_recurrence | create_recurrence | dumpthis | t_module_association | create_module_association"
    },
    create_catalogs {
      pipe = "read_modules | t_catalog | setup_catalog | dumpthis | t_catalog_put | set_catalog_search | module_uuid  | dumpthis | t_catalog_module | assign_catalog_module"
    },
    delete_all_schedules
      {
        pipe = "get_schedules | tr1 | dumpthis | merge_del_schedule | delete_schedules "
      },
    delete_catalogs
      {
        pipe = " get_catalogs | tr1 | dumpthis | t_del_catalog | process_delete_catalogs "
      }
  },
  startup {
    exec = "delete_all_schedules"
  }

}
