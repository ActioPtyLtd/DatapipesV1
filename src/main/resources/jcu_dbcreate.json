{
  "script": {
    "schema": {},
    "schedule": {},
    "tasks": {
      "read-user-data": {
        "type": "extract",
        "dataSource": {
          "type": "sql",
          "jdbcDriver": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
          "connect": "jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
          "query": {
            "queryTemplate": "",
            "read": "select distinct PresenterUsername presenterusername,PresenterFullname presenterfullname,case when charindex(',',[PresenterFullname],0) = 0 then PresenterFullname else right(presenterfullname,len(presenterfullname)-charindex(',',[PresenterFullname],0)) end firstname,case when charindex(',',[PresenterFullname],0) = 0 then 'n/a' else left (presenterfullname, charindex(',',[PresenterFullname],0)-1) end lastname,coalesce([PresenterEmail],PresenterUsername+'@jcu.edu.au') email from current_activities where PresenterUsername is not null order by PresenterUsername desc"
          }
        }
      },
      "template": {
        "type": "mergeTemplate",
        "templates": {
          "createbody": "{ \"UserName\": \"$presenterusername\",\"DisplayName\": \"$presenterfullname\",\"Email\":\"$email\",\"Activated\": true,\"ModeratorEmail\": \"jmckinney_webcastcloud.com.au\",\"ModeratorEmailOptOut\": false,\"DisablePresentationContentCompleteEmails\": false,\"DisablePresentationContentFailedEmails\": true,\"DisablePresentationChangeOwnerEmails\": true,\"TimeZone\": 19,\"PresenterFirstName\": \"$firstname\",\"PresenterLastName\": \"$lastname\",\"PresenterEmail\": \"jmckinneywebcastcloud.com.au\",\"PresenterPrefix\": \"null\",\"PresenterSuffix\": \"null\",\"PresenterAdditionalInfo\": \"null\",\"PresenterBio\": \"null\" }"
        }
      },
      "update-mediasite-users": {
        "type": "datasourceupdate",
        "behavior": "",
        "iterateR": "ds => ds.value",
        "keyL": "${row.presenterusername}",
        "keyR": "$UserName",
        "changeL": "${row.presenterfullname}",
        "changeR": "$DisplayName",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "create": {
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/UserProfiles",
              "body": "createbody"
            },
            "read": {
              "uri": "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/UserProfiles"
            }
          }
        }
      },
      "create-users": {
        "type": "include",
        "behavior": "simple",
        "foreach": "*",
        "attribute": "user",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/UserProfiles",
              "body": "{ \"UserName\": \"~{d.global.PresenterUsername}\",\"DisplayName\": \"~{d.global.PresenterFullname}\",\"Email\":\"~{d.global.email}\",\"Activated\": true,\"ModeratorEmail\": \"jmckinney_webcastcloud.com.au\",\"ModeratorEmailOptOut\": false,\"DisablePresentationContentCompleteEmails\": false,\"DisablePresentationContentFailedEmails\": true,\"DisablePresentationChangeOwnerEmails\": true,\"TimeZone\": 19,\"PresenterFirstName\": \"~{d.global.firstname}\",\"PresenterLastName\": \"~{d.global.lastname}\",\"PresenterEmail\": \"~{d.global.email}\"}"
            }
          }
        }
      },
      "process-module-header": {
        "type": "transform",
        "batch": [
          "split2cols, col1",
          "row1header",
          "deDup,ModuleId"
        ]
      },
      "iterate-users": {
        "type": "iterate",
        "behavior": "iterate",
        "iterate": "*"
      },
      "iterate-module": {
        "type": "iterate",
        "behavior": "iterate",
        "iterate": "*"
      },
      "create-module-merge": {
        "type": "merge",
        "behavior": "simple",
        "attribute": "module",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Modules",
              "body": "{ \"ModuleId\": \"ZZ~{d.ModuleName}\", \"Name\": \"ZZ~{d.ModuleName}\", \"Description\": \"~{d.ModuleDescription}\", \"Owner\": \"MediasiteAdmin\"}"
            }
          }
        }
      },
      "create-folder-merge": {
        "type": "merge",
        "behavior": "simple",
        "attribute": "folder",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Folders",
              "body": "{ \"Name\": \"~{d.module.response.root.ModuleId}\", \"Owner\": \"LECTURER\", \"ParentFolderId\": \"a1d05da916264510bb98cb94d9ba4e7614\", \"Recycled\": false, \"Type\": \"Folder\", \"IsShared\": false, \"IsCopyDestination\": true, \"IsReviewEditApproveEnabled\": true}"
            }
          }
        }
      },
      "owner-folder-merge": {
        "type": "merge",
        "behavior": "simple",
        "attribute": "ownerfolder",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Folders('~{d.folder.response.root.Id}')/UpdateOwner",
              "body": "{ \"Owner\": \"~{d.USERNAME}\" }"
            }
          }
        }
      },
      "create-schedule-merge": {
        "type": "merge",
        "behavior": "simple",
        "attribute": "schedule",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Schedules",
              "body": "{\"ScheduleTemplateId\":\"0eddda4fd7304a0ca530acf593b76d3f0b\",  \"RecorderId\":\"eefd2ec11f5749fd9ab777f2c1f358d816\",  \"Name\": \"Schedule_APIcreated\",  \"TitleType\": \"ScheduleNameAndAirDateTime\",  \"FolderId\": \"~{d.folder.response.root.Id}\",  \"AdvanceCreationTime\": \"172800\",  \"AdvanceLoadTimeInSeconds\": \"120\",  \"CreatePresentation\": \"true\",  \"LoadPresentation\": \"true\",  \"AutoStart\": \"true\",  \"AutoStop\": \"true\",  \"ReceipientsEmailAddresses\": \"jmckinney@webcastcloud.com.au\",  \"NextNumberInSchedule\": \"2\",  \"Description\": \"Presentation Created via API w/ Presenter email sent Hopefully\",  \"ReviewEditApproveEnabled\": \"true\"}"
            }
          }
        }
      },
      "assign-schedule-module-merge": {
        "type": "merge",
        "behavior": "simple",
        "attribute": "schedulemodule",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "6ee2ac1c-6045-496f-892e-a0ad3dd5976c"
          },
          "credential": {
            "user": "ACTIO",
            "password": "ACTIO1234!"
          },
          "query": {
            "create": {
              "uri": "http://devmediasite.webcastcloud.com.au/mediasite/api/v1/Modules('~{d.module.response.root.Id}')/AddAssociation",
              "body": "{\"MediasiteId\":\"~{d.schedule.response.root.Id}\"}"
            }
          }
        }
      }
    },
    "pipelines": {
      "test-sql" : {
        "pipe" : "read-user-data"
      },
      "create-users": {
        "pipe": "read-user-data | template | update-mediasite-users"
      },
      "read-modules-demo": {
        "pipe": "read-data-file | process-module-header | iterate-module | create-module-merge | create-folder-merge | owner-folder-merge | create-schedule-merge | assign-schedule-module-merge"
      }
    },
    "services": {},
    "startup": {
      "exec": "create-users"
    }
  }
}


