{
  "script": {
    "schema": {},
    "tasks": {
      "dumpthis": {
        "type": "dump"
      },
      "get_users": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "sql",
          "behavior": "",
          "jdbcDriver":"com.microsoft.sqlserver.jdbc.SQLServerDriver",
          "connect":"jdbc:sqlserver://corptestmdb01.jcu.edu.au:1433;user=mediasite_ro;password=afcfh8742Nch7y1SA",
          "query": {
            "queryTemplate": "",
            "read": "select distinct presenterusername,presenterfullname,ltrim(case when charindex(',',[PresenterFullname],0) = 0 then PresenterFullname else right(presenterfullname,len(presenterfullname)-charindex(',',[PresenterFullname],0)) end) firstname,case when charindex(',',[PresenterFullname],0) = 0 then 'n/a' else left (presenterfullname, charindex(',',[PresenterFullname],0)-1) end lastname,coalesce([PresenterEmail],PresenterUsername+'@jcu.edu.au') email from current_activities where PresenterUsername is not null order by PresenterUsername desc"
          }
        }
      },
      "t_create_user": {
        "type": "mergeTemplate",
        "templates": {
          "createbody": "{ \"UserName\": \"$presenterusername\",\"DisplayName\": \"$presenterfullname\",\"Email\":\"$presenterusername@actio.com.au\",\"Activated\": true,\"ModeratorEmail\": \"jmckinney_webcastcloud.com.au\",\"ModeratorEmailOptOut\": false,\"DisablePresentationContentCompleteEmails\": false,\"DisablePresentationContentFailedEmails\": true,\"DisablePresentationChangeOwnerEmails\": true,\"TimeZone\": 19,\"PresenterFirstName\": \"$firstname\",\"PresenterLastName\": \"$lastname\",\"PresenterEmail\": \"$email\" }"
        }
      },
      "create_users" : {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "headers": {
            "Content-Type": "application/json",
            "sfapikey": "25da71cb-4032-49b3-8fe0-11ceb5f4e3a9"
          },
          "credential": {
            "user": "ACTIO",
            "password": "actio1234"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri":  "https://mediasiteDEV.jcu.edu.au/mediasite/api/v1/UserProfiles",
              "body": "createbody"
            }
          }
        }
      }
    },
    "pipelines": {
      "create_user" : {
        "pipe": "get_users | t_create_user | create_users"
      },
      "dump_user" : {
        "pipe": "get_users | t_create_user | dumpthis"
      }
    },
    "startup": {
      "exec": "create_user"
    }
  }
}
