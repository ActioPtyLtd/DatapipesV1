{
  "script": {
    "schema": {},
    "tasks": {
      "read-product-api": {
        "type": "extract",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "https://stage-api-gnm.actio.com.au:8443/api/product?filter[product.type]=lens&fields[product]=id&page[limit]=10000"
            }
          }
        }
      },
      "getdata": {
        "type": "transformTerm",
        "term": "ds => batch(ds.data)"
      },
      "template-getlens": {
        "type": "mergeTemplate",
        "templates": {
          "getlens": "https://stage-api-gnm.actio.com.au:8443/api/product/$id?include=lens,stocks"
        }
      },
      "lookuplens": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "getlens"
            }
          }
        }
      },
      "template-csv": {
        "type": "mergeTemplate",
        "templates": {
          "col": "${lookuplens(0).data.id},${lookuplens(0).data.id},${lookuplens(0).data.attributes.description},${lookuplens(0).data.attributes.description},54,30,${lookuplens(0).included(0).attributes.material},1,FALSE,${lookuplens(0).data.attributes.retailPrice},0,10,10,${lookuplens(0).data.attributes.wholesalePriceTax},19.22,671,,672,,${lookuplens(0).data.id},${lookuplens(0).data.id},G,,BF"
        }
      },
      "getlines": {
        "type": "transformTerm",
        "term": "ds => batch(maprecord(ds.*.col))"
      },
      "load-product-csv": {
        "type": "load",
        "behavior": "simple",
        "dataSource": {
          "behavior" : "append",
          "directory": "c://tmp//",
          "type": "file",
          "filenameTemplate": "test.csv",
          "outputDelimiter": ",",
          "header": "gnmcode,lens_code,lab_description,invoice_description,lens_size,seg_size,lens_material,preference_number,discontinued,retail_price_inc_tax,wholesale_price_excl_tax,retail_price_tax_percentage,wholesale_price_tax_percentage,wholesale_price_incl_tax,ref_index,health_fund_items_1lens_1,health_fund_items_1lens_2 string,health_fund_items_2lens_1,health_fund_items_2lens_2,eyetalk_code,eyetalk_permanent_id,stock_or_grind,base_curve,price_list_group"
        }
      }
    },
    "pipelines": {
      "load-product" : {
        "pipe": "read-product-api | getdata | template-getlens | lookuplens | template-csv | getlines| load-product-csv"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-product"
    }
  }
}
