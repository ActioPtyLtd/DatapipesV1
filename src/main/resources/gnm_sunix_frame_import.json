{
  "script": {
    "schema": {},
    "tasks": {
      "read-product-api": {
        "type": "extract",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "https://stage-api-gnm.actio.com.au:8443/api/product?filter[product.assortments.stores.id]=26&fields[product]=id&page[limit]=10000"
            }
          }
        }
      },
      "getdata": {
        "type": "transformTerm",
        "term": "ds => batch(ds.data)"
      },
      "template-getframe": {
        "type": "mergeTemplate",
        "templates": {
          "getframe": "https://stage-api-gnm.actio.com.au:8443/api/product/$id?include=frame,stocks"
        }
      },
      "lookupframe": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "getframe"
            }
          }
        }
      },
      "template-csv": {
        "type": "mergeTemplate",
        "templates": {
          "col": "${lookupframe(0).data.id},${lookupframe(0).data.attributes.brand},${lookupframe(0).included(0).attributes.model},${lookupframe(0).included(0).attributes.colour},${lookupframe(0).included(0).attributes.eye_size},${lookupframe(0).included(0).attributes.bridge_size},${lookupframe(0).included(0).attributes.temple_length},${lookupframe(0).included(0).attributes.depth},f,FALSE,${lookupframe(0).included(0).attributes(\"type\")},${lookupframe(0).data.attributes.retailPrice},0,${lookupframe(0).data.attributes.wholesalePriceTax},${lookupframe(0).data.attributes.wholesalePrice},${lookupframe(0).data.attributes.apn},${lookupframe(0).included(1).attributes.quantity}"
        }
      },
      "getlines": {
        "type": "transformTerm",
        "term": "ds => batch(maprecord(ds.*.col))"
      },
      "load-product-csv": {
        "type": "load",
        "behavior": "simple",
        "dataSource": {
          "behavior" : "append",
          "directory": "c://tmp//",
          "type": "file",
          "filenameTemplate": "test.csv",
          "outputDelimiter": ",",
          "header": "gnmcode,frame_brand,frame_model,frame_colour,frame_eye_size,frame_bridge_size,frame_temple_length,frame_depth,frame_group,frame_rx,frame_type,retail_price_incl_tax ,wholesale_price_excl_tax,wholesale_price_tax,wholesale_price_incl_tax,supplier_barcode,supplier_stock_status"
        }
      }
    },
    "pipelines": {
      "load-product" : {
        "pipe": "read-product-api | getdata | template-getframe | lookupframe | template-csv | getlines| load-product-csv"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-product"
    }
  }
}
