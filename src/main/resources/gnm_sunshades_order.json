{
  "script": {
    "schema": {},
    "tasks": {
      "read-job-api": {
        "type": "extract",
        "behavior": "",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "https://stage-api-gnm.actio.com.au:8443/api/job?filter[job.status]=CREATED&filter[job.supplier.id]=1"
            }
          }
        }
      },
      "getdata": {
        "type": "transformTerm",
        "term": "ds => batch(ds.data)"
      },
      "lookuptemplates": {
        "type": "mergeTemplate",
        "templates": {
          "orderuri": "https://stage-api-gnm.actio.com.au:8443/api/order/${relationships.order.data.id}?include=address,customer",
          "addressuri": "https://stage-api-gnm.actio.com.au:8443/api/address/${relationships.address.data.id}",
          "productaliasuri": "https://stage-api-gnm.actio.com.au:8443/api/productAlias?filter[productAlias.aliasPrefix]=SUNSHADES&filter[productAlias.product.productId]=${relationships.product.data.id}&page[size]=1"
        }
      },
      "getorder": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "orderuri"
            }
          }
        }
      },
      "getproduct": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "uri": "productaliasuri"
            }
          }
        }
      },
      "templatesubmit": {
        "type": "mergeTemplate",
        "templates": {
          "submitbody": "{ \"batches\": [{ \"batch\": \"${getorder(0).data.id}\", \"jobs\": [{ \"account\": \"205336\", \"address1\": \"${getorder(0).included(0).attributes.street1}\", \"address2\": \"${getorder(0).included(0).attributes.street2}\", \"carrier\": \"car1\", \"jobid\": \"${item.id}\", \"lines\": [{ \"quantity\": ${item.attributes.quantity}, \"stockid\": \"${getproduct(0).data(0).attributes.aliasId}\"}], \"name\": \"${getorder(0).included(1).attributes.firstName} ${getorder(0).included(1).attributes.lastName}\", \"postcode\": \"${getorder(0).included(0).attributes.postcode}\", \"state\": \"${getorder(0).included(0).attributes.state}\", \"suburb\": \"${getorder(0).included(0).attributes.suburb}\"}]}]}"
        }
      },
      "submitorder": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "gm",
            "password": "83498dd4fa301a3aa2d117b13d371526"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "https://api.sunshad.es/v1/orders",
              "body": "submitbody"
            }
          }
        }
      },
      "templateupdateorder": {
        "type": "mergeTemplate",
        "templates": {
          "updateorderuri": "https://stage-api-gnm.actio.com.au:8443/service/job/${record.item.id}/status",
          "updateorderbody": "{\"action\": \"SUPPLIER_SUBMITTED\",\"comment\": \"Sunshades Ref#: ${submitorder(0).txid}\"}"
        }
      },
      "update-job-status-api": {
        "type": "lookup",
        "behavior": "simple",
        "dataSource": {
          "type": "rest",
          "behavior": "simple",
          "path": "-",
          "credential": {
            "user": "dpipes",
            "password": "L3tM37n!"
          },
          "query": {
            "read": {
              "verb": "post",
              "uri": "updateorderuri",
              "body": "updateorderbody"
            }
          }
        }
      }
    },
    "pipelines": {
      "load-job" : {
        "pipe": "read-job-api | getdata | lookuptemplates | getorder | getproduct| templatesubmit | submitorder | templateupdateorder | update-job-status-api"
      }
    },
    "services": { },
    "startup": {
      "exec": "load-job"
    }
  }
}
