include "gnm_localenv.conf"

script {
  schema {},
  tasks {
    read-sundry-dbf {
      type = "extract",
      behavior = "",
      dataSource = ${dbf_datasource},
      dataSource {
        filenameTemplate = "VPRODUCT.DBF"
      }
    },
    template {
      type = "mergeTemplate",
      templates {
        create = "insert into storeproduct (storeid,productid,\"type\",datecreated,name,description,retailprice,wholesaleprice,modified,last_purchase,last_sale,quantity) values ('"${store}"', '"${store}"-$PRODCODE', 'Sundry', current_date,'${sq(DESC)}','$PRODCODE',${numeric(RRP)},${numeric(COSTPRICE)}, '${dateFormat(MODIFIED,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp, '${dateFormat(LASTPUR,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp, '${dateFormat(LASTSALE,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp, ${numeric(QUANTITY)})",
        update = "update storeproduct set name='${sq(DESC)}',description='$PRODCODE',retailprice=${numeric(RRP)},wholesaleprice=${numeric(COSTPRICE)}, modified='${dateFormat(MODIFIED,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp, last_purchase='${dateFormat(LASTPUR,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp, last_sale='${dateFormat(LASTSALE,\"yyyy-MM-dd HH:mm:ss\")}'::timestamp,quantity=${numeric(QUANTITY)} WHERE productid='"${store}"-$PRODCODE'"
      }
    },
    update-product-db {
      type = "datasourceupdate",
      iterateR = "ds => ds",
      keyL = ${store}"-${row.PRODCODE}",
      keyR = "$productid",
      changeL = "${dateFormat(row.MODIFIED,\"yyyy-MM-dd HH:mm:ss\")}",
      changeR = "${dateFormat(modified,\"yyyy-MM-dd HH:mm:ss\")}",
      dataSource = ${dwh_datasource},
      dataSource {
        query {
          create = "create",
          read = "select productid, modified FROM storeproduct",
          update = "update"
        }
      }
    }
  },
  pipelines {
    load-sundry {
      pipe = "read-sundry-dbf | template | update-product-db"
    }
  },
  services { },
  startup {
    exec = "load-sundry"
  }
}

