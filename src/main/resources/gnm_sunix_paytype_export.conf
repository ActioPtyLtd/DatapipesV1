include "gnm_localenv.conf"

  script {
    schema {},
    tasks {
      read-code-dbf {
        type = "extract",
        behavior = "",
        dataSource {
          type = "file",
          behavior = "DBF",
          directory = ${script.variables.dbf_folder},
          filenameTemplate = "VCODE.DBF"
        }
      },
      filter {
        type = "transformTerm",
        term = "ds => batch(ds.filter(d => d.GROUP == \"PY\"))"
      },
      template {
        type = "mergeTemplate",
        templates {
          create = "insert into paymenttype (paymenttypeid,name) values ('"${script.variables.store}"-$GROUP-$CODE','$DESCPTN')",
          update = "update paymenttype set name='$DESCPTN' where paymenttypeid='"${script.variables.store}"-$GROUP-$CODE'"
        }
      },
      update-paytype-db {
        type = "datasourceupdate",
        behavior = "",
        iterateR = "ds => ds",
        keyL = ${script.variables.store}"-${row.GROUP}-${row.CODE}",
        keyR = "$paymenttypeid",
        changeL = "${row.DESCPTN}",
        changeR = "$name",
        dataSource {
          type = "sql",
          behavior = "",
          jdbcDriver = "org.postgresql.Driver",
          connect = ${script.variables.dwh_connection},
          query {
            queryTemplate = "",
            create = "create",
            read = "select paymenttypeid,name FROM paymenttype",
            update = "update"
          }
        }
      }
    },
    pipelines {
      load-paytype {
        "pipe" : "read-code-dbf | filter | template | update-paytype-db"
      }
    },
    services { },
    startup {
      exec = "load-paytype"
    }
  }

